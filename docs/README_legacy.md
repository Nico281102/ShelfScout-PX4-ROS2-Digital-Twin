# Over-Rack Inventory Scan (PX4 + ROS 2)

## Overview
Over-Rack Scan is a test environment for validating indoor PX4 missions with ROS 2 and Gazebo Classic. It ships a reproducible stack built on PX4 SITL (release 1.14.4), the Micro XRCE-DDS Agent bridge, and a ROS 2 node that publishes Offboard setpoints from a YAML mission plan. The indoor world recreates a shelf aisle with barcode markers to exercise scanning and coverage pipelines. Bash scripts orchestrate the full launch: workspace build, `GAZEBO_MODEL_PATH` setup, PX4 start, bridge spawn, and mission runner start. Logs and assets live in-repo to speed up debugging and metric analysis (hover drift, coverage, CPU temps). Optional utilities support CV pipelines and Gazebo model maintenance.

## Repository Layout
```text
overrack-scan/
├── scripts/
│   · Orchestrators (`run_ros2_system.sh`) and PX4/Gazebo wrappers (`launch_px4_gazebo.sh`, `launch_gazebo.sh`).
│   · Support tools (Iris model patch, venv setup) and optional pipelines (`run_vision.py`).
│   · Legacy/manual scripts (e.g., removed `run_manual_like.sh`, FSM demos) plus runtime assets (`data/`, `test_data/`).
│   · Depends on `PX4_DIR`, `config/mission.yaml`, `worlds/overrack_indoor.world`, and the Micro XRCE Agent.
│   · Status: active baseline; some utilities marked legacy/zombie in the structure report.
├── ros2_ws/src/
│   · Isolated ROS 2 workspace with `overrack_mission` (mission runner), `px4_msgs`, and reference `px4_ros_com`.
│   · Built by `run_ros2_system.sh` via `colcon --packages-select px4_msgs overrack_mission`.
│   · Main source for the `mission_runner` node executed at runtime.
│   · Ships official PX4 DDS messages and matching QoS profiles.
│   · Status: active (`mission_runner`); reference (`px4_ros_com`) not compiled by default.
├── config/
│   · `mission.yaml` points to a precomputed `route_file` and sets cruise speed plus thresholds (drift, temperature).
│   · No SITL params file is shipped; the loader stays disabled to avoid regressions.
│   · Loaded by `overrack_mission` and previously by the legacy mission runner under `src/`.
│   · Edit here to customise missions and alert thresholds; routes live under `config/routes/*.yaml`.
│   · Status: `mission.yaml` active; bring your own PX4 params only after validation.
├── models/
│   · Custom Gazebo models: shelves (`overrack_shelf`), markers (`scan_marker`), barcode board.
│   · Used by the SDF world to recreate the indoor aisle.
│   · Added to the environment via `GAZEBO_MODEL_PATH` in `launch_px4_gazebo.sh`.
│   · Compatible with Gazebo Classic 11 and the PX4 `iris_opt_flow` model.
│   · Status: active (aligned with the current world).
├── worlds/
│   · `overrack_indoor.world`: main SDF with room, shelves, overhead camera, and markers.
│   · References `models/` assets and saves frames to `data/images/downcam`.
│   · Used by the launch scripts for PX4 and for standalone Gazebo sessions.
│   · Editing poses or assets requires touching both the SDF and `config/mission.yaml`.
│   · Status: active.
├── data/
│   · Runtime outputs (`logs/`, `images/`, `state/`) generated by the scripts.
│   · Logs include PX4, Micro XRCE Agent, and mission runner; images come from the SDF camera.
│   · Directories are cleared by scripts only when needed (do not delete manually).
│   · Useful for troubleshooting and for feeding the vision pipeline.
│   · Status: generated at runtime.
├── src/
│   · Legacy mission runner (full FSM) and demos (`run_demo.py`, `run_visual_demo.py`).
│   · Not wired into the ROS 2 workspace; run manually (`python -m src.main`).
│   · Some demos are currently broken (`MissionFSM` removed).
│   · Keep only if you plan to resurrect the advanced FSM or custom CSV pipelines.
│   · Status: legacy/experimental (see structure_review).
└── docs/
    · Additional documentation: specs, migration notes, structure review.
    · `docs/structure_review.md` holds detailed analysis + zombie list.
    · Update here any architectural changes or shared procedures.
    · Keep PDFs and legacy notes separate from the main README.
    · Status: active with mixed freshness (some items to update).
```

## Prerequisites
- Ubuntu 22.04 LTS (desktop or with graphical forwarding) and Python 3.10.
- ROS 2 Humble (desktop install with `colcon` and `rosdep`).
- PX4-Autopilot v1.14.4 already cloned and built once (`make px4_sitl_default`).
- Micro XRCE-DDS Agent v2.4.3 (binary `MicroXRCEAgent` on `PATH` or local build).
- Gazebo Classic 11 with packages `gazebo`, `gzserver`, `gzclient`, and PX4 dependencies.
- Optional vision deps: `opencv-python`, `pyzbar`, `zxing-cpp`, `mavsdk`, `psutil` (via `pip install -r requirements.txt`).

## Quick Setup
- **Prepare PX4**
  ```bash
  git clone https://github.com/PX4/PX4-Autopilot.git ~/PX4/PX4-Autopilot
  cd ~/PX4/PX4-Autopilot
  git checkout v1.14.4
  make px4_sitl_default
  ```
  > Point `PX4_DIR` to your PX4 folder when launching scripts (`export PX4_DIR=~/PX4/PX4-Autopilot`).

- **Install ROS 2 dependencies and colcon**
  ```bash
  sudo apt update
  sudo apt install ros-humble-desktop python3-colcon-common-extensions ros-humble-micro-xrce-dds-agent
  ```

- **Build the ROS 2 workspace** (scripts do this automatically, but useful for debugging)
  ```bash
  cd ~/projects/overrack-scan/ros2_ws
  colcon build --symlink-install --packages-select px4_msgs overrack_mission
  source install/setup.bash
  ```

- **Suggested environment variables**
  ```bash
  export PX4_DIR=~/PX4/PX4-Autopilot
  export PROJECT_ROOT=~/projects/overrack-scan
  # optional: add models to the path (scripts do this automatically)
  export GAZEBO_MODEL_PATH="$PX4_DIR/Tools/simulation/gazebo-classic/sitl_gazebo-classic/models:$PROJECT_ROOT/models:${GAZEBO_MODEL_PATH:-}"
  export PX4_SIM_MODEL=iris_opt_flow   # avoid accidental overrides
  ```
  > No PX4 params file is shipped: keep `PX4_RC_PARAMS_FILE` unset unless you provide a validated file and re-enable the loader.

## Run
- **Automatic stack**
  ```bash
  cd ~/projects/overrack-scan
  PX4_DIR=~/PX4/PX4-Autopilot \
  scripts/run_ros2_system.sh --gui \  # usa --headless per disabilitare la GUI
    --world worlds/overrack_indoor.world \
    --mission config/mission.yaml
  ```
  - Starts PX4 SITL with model `gazebo-classic_iris_opt_flow` (see `scripts/launch_px4_gazebo.sh:78-103`).
  - Extends `GAZEBO_MODEL_PATH` with PX4 and local models in the right order.
  - Finds or launches `MicroXRCEAgent udp4 -p 8888 -v 6` and waits for `/fmu/out/*` topics (`scripts/run_ros2_system.sh:182-195`).
  - Runs `ros2 run overrack_mission mission_runner` with the selected mission file.

- **Manual-like script (legacy)**
  ```bash
  # run_manual_like.sh was removed; use scripts/run_ros2_system.sh
  # use scripts/stop_manual_like.sh to kill PX4/Gazebo/Agent if needed
  ```

- **Verify**
  ```bash
  source ros2_ws/install/setup.bash
  ros2 topic list | grep /fmu
  tail -f data/logs/px4_sitl_default.out
  ```

## Troubleshooting
- **Environment & PATH**
  - `ros2` cannot see topics → `source ros2_ws/install/setup.bash` and avoid mixing `/opt/ros/humble/setup.bash` unless needed.
  - Scripts must run `source "$ROS2_WS/install/setup.bash"` after defining `ROS2_WS` (see `scripts/run_ros2_system.sh`).

- **Micro XRCE-DDS Agent**
  - PX4 cannot reach the agent → start `MicroXRCEAgent udp4 -p 8888 -v 6` before the mission runner and inspect `data/logs/micro_xrce_agent.out`.
  - On SSH/headless setups run it in the same terminal or via `tmux` (avoid `gnome-terminal`).

- **PX4 + Gazebo**
  - Wrong model (plain `iris`) → force `PX4_SIM_MODEL=iris_opt_flow` and ensure `models/` does not contain `iris*` (`launch_px4_gazebo.sh:84-94`).
  - Drone spawned inside an obstacle → check the `<pose>` in the world or let PX4 handle spawn by using the empty environment.
  - "PX4 server already running" → `pkill -f "px4|gzserver|gzclient|MicroXRCEAgent"`.

- **Parameters & preflight**
  - Arming blocked (IMU/GPS) → the `iris_opt_flow` model provides the required plugins; indoors enable `COM_ARM_WO_GPS=1` directly from the PX4 console.
  - `.params` file → if you want to experiment, provide your own params file and only then re-enable the loader (see `launch_px4_gazebo.sh:58-65`).

- **Startup timing**
  - Missing `/fmu/out` topics → wait 10–15 s after PX4 bootstrap before launching ROS 2 or use the built-in `wait_for_topic`.
  - Mission runner starts too early → check `px4_sitl_default.out` for "Ready for takeoff".

- **Vision & logs**
  - Missing images → the overhead camera writes to `data/images/downcam`; verify folder permissions and disk space.
  - `run_vision.py` pipeline → needs optional libraries; run with `python scripts/run_vision.py --watch data/images/downcam`.

- **Clean shutdown**
  ```bash
  pkill -f mission_runner
  pkill -f MicroXRCEAgent
  pkill -f px4
  pkill -f gzserver
  pkill -f gzclient
  ```

## Contributions & Conventions
1. **New scripts**: keep descriptive prefixes (`run_`, `launch_`, `fix_`) and document usage in the README and `docs/structure_review.md`. Handle `PX4_DIR`, `ROS2_WS`, and env vars consistently with existing scripts.
2. **Models & worlds**: add new assets under `models/<name>` with `model.config` + `model.sdf` and update the world or create a dedicated `.world`. Document which world/model to use in the README.
3. **PX4 parameters**: work on your own `.params` file; do not enable automatic loading until tested. Document relevant parameters in `docs/structure_review.md` or a dedicated note.
4. **ROS 2 mission runner**: add new functionality inside `ros2_ws/src/overrack_mission`. Update `package.xml`, `setup.py`, and add tests/launch files if extra topics are introduced.
5. **Documentation**: any substantial change (new script, launch flow change, world swap) must be reflected both in this README and in the report in `docs/structure_review.md`. Keep `docs/ROS2_MIGRATION.md` aligned when altering the bridge architecture.

For the full structure and legacy component details, see the updated `docs/structure_review.md`.
