#!/usr/bin/env bash
# ShelfScout PX4-ROS2 Digital Twin â€“ operator profile template (SSDT = ShelfScout Digital Twin)
# Copy this file to scripts/.env and adjust the paths to match your system.

if [[ -n "${SSDT_ENV_LOADED:-}" ]]; then
  return 0 2>/dev/null || exit 0
fi
export SSDT_ENV_LOADED=1

SSDT_ENV_FILE="${BASH_SOURCE[0]}"
SSDT_ENV_DIR="$(cd "$(dirname "${SSDT_ENV_FILE}")" && pwd)"
export SSDT_ROOT="${SSDT_ROOT:-$(cd "${SSDT_ENV_DIR}/.." && pwd)}"

ssdt_prepend_path() {
  local var_name="$1"
  local new_dir="$2"
  [[ -z "$var_name" || -z "$new_dir" ]] && return 0
  new_dir="${new_dir%/}"
  local current="${!var_name:-}"
  case ":${current}:" in
    *:"${new_dir}":*) return 0 ;;
  esac
  if [[ -n "$current" ]]; then
    printf -v "$var_name" '%s' "${new_dir}:${current}"
  else
    printf -v "$var_name" '%s' "${new_dir}"
  fi
  export "$var_name"
}

ssdt_resolve_path() {
  local candidate="$1"
  if [[ -z "$candidate" ]]; then
    return 0
  fi
  if [[ "$candidate" = /* ]]; then
    printf '%s\n' "$candidate"
  else
    printf '%s/%s\n' "$SSDT_ROOT" "$candidate"
  fi
}

ssdt_source_ros() {
  local had_u=0
  if [[ $- == *u* ]]; then
    had_u=1
    set +u
  fi

  local distro_setup="/opt/ros/${SSDT_ROS_DISTRO}/setup.bash"
  if [[ -f "$distro_setup" ]]; then
    # shellcheck disable=SC1090
    source "$distro_setup"
  else
    echo "[ssdt] WARN: missing ROS 2 distro setup: $distro_setup" >&2
  fi

  local overlay_setup="$SSDT_ROS_WS/install/setup.bash"
  if [[ -f "$overlay_setup" ]]; then
    # shellcheck disable=SC1090
    source "$overlay_setup"
  else
    echo "[ssdt] WARN: missing workspace overlay: $overlay_setup" >&2
  fi

  if (( had_u )); then
    set -u
  fi
}

# === Core inputs (set these) ===
export SSDT_PX4_DIR="${SSDT_PX4_DIR:-$HOME/PX4/PX4-Autopilot}"
export SSDT_ROS_WS="${SSDT_ROS_WS:-$SSDT_ROOT/ros2_ws}"
export SSDT_ROS_DISTRO="${SSDT_ROS_DISTRO:-humble}"

# === Simulation defaults (optional overrides) ===
export SSDT_HEADLESS_DEFAULT="${SSDT_HEADLESS_DEFAULT:-1}"
export SSDT_WORLD="${SSDT_WORLD:-worlds/overrack_indoor.world}"
export SSDT_MISSION_FILE="${SSDT_MISSION_FILE:-config/mission_precomputed.yaml}"
export SSDT_PARAM_PATH="${SSDT_PARAM_PATH:-}"             # default is config/sim/multi_1drone.yaml
export SSDT_AGENT_CMD="${SSDT_AGENT_CMD:-MicroXRCEAgent udp4 -p 8888 -v 6}"

# === Logging / health (optional) ===
export SSDT_LOG_DIR="${SSDT_LOG_DIR:-$SSDT_ROOT/data/logs}"
export SSDT_GZSERVER_TIMEOUT="${SSDT_GZSERVER_TIMEOUT:-40}"
export SSDT_TOPIC_TIMEOUT="${SSDT_TOPIC_TIMEOUT:-60}"
export SSDT_REQUIRE_GZSERVER="${SSDT_REQUIRE_GZSERVER:-1}"
export SSDT_REQUIRE_PX4_TOPICS="${SSDT_REQUIRE_PX4_TOPICS:-1}"
export SSDT_GZ_GRACE="${SSDT_GZ_GRACE:-8}"

# === Optional: Micro XRCE Agent path (if not in PATH) ===
export SSDT_MICRO_XRCE_DIR="${SSDT_MICRO_XRCE_DIR:-$HOME/PX4/Micro-XRCE-DDS-Agent}"
export SSDT_MICRO_XRCE_BIN_DIR="${SSDT_MICRO_XRCE_BIN_DIR:-$SSDT_MICRO_XRCE_DIR/build/install/bin}"
ssdt_prepend_path PATH "$SSDT_MICRO_XRCE_BIN_DIR"

# === Optional: Gazebo torch plugin path ===
ssdt_prepend_path GAZEBO_PLUGIN_PATH "$SSDT_ROS_WS/install/overrack_light_plugin/lib"

# === Legacy aliases for compatibility ===
export PX4_DIR="$SSDT_PX4_DIR"
export MICRO_XRCE_AGENT_DIR="$SSDT_MICRO_XRCE_DIR"
export PATH_MICRO_XRCE_AGENT="$SSDT_MICRO_XRCE_BIN_DIR"

if ! declare -F shelfscout_resolve_path >/dev/null 2>&1; then
  shelfscout_resolve_path() { ssdt_resolve_path "$@"; }
fi
if ! declare -F shelfscout_source_ros >/dev/null 2>&1; then
  shelfscout_source_ros() { ssdt_source_ros "$@"; }
fi
